<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="echo.sp.app.dao.UserTaskDAO">
	<insert id="addTask" parameterType="map">
	    INSERT INTO T_TASKS 
			(
				TASK_ID,
				USER_ID,
				SECTOR_ID,
				SECTOR_TYPE,
				TASK_TITLE,
				TASK_DESC,
				TASK_DEADLINE,
				TASK_PAID,
				TASK_ADDR,
				TASK_LONGITUDE,
				TASK_LATITUDE,
				TASK_ICON1,
				TASK_ICON2,
				TASK_ICON3,
				TASK_ICON4,
				TASK_AUDIT_STATUS,
				TASK_STATUS,
				TASK_CREATE_TIME 
			)
		VALUES
			(
				#{TASK_ID},
				#{USER_ID},
				#{SECTOR_ID},
				#{SECTOR_TYPE},
				#{TASK_TITLE},
				#{TASK_DESC},
				#{TASK_DEADLINE},
				#{TASK_PAID,jdbcType=NUMERIC},
				#{TASK_ADDR},
				#{TASK_LONGITUDE,jdbcType=NUMERIC},
				#{TASK_LATITUDE,jdbcType=NUMERIC},
				#{TASK_ICON1},
				#{TASK_ICON2},
				#{TASK_ICON3},
				#{TASK_ICON4},
				#{TASK_AUDIT_STATUS},
				#{TASK_STATUS},
				#{TASK_CREATE_TIME} 
			)
    </insert>
    <update id="updateTask" parameterType="map">  
        UPDATE T_TASKS 
		SET
			SECTOR_ID=#{SECTOR_ID},
			SECTOR_TYPE=#{SECTOR_TYPE},
			TASK_TITLE=#{TASK_TITLE},
			TASK_DESC=#{TASK_DESC},
			TASK_DEADLINE=#{TASK_DEADLINE},
			TASK_PAID=#{TASK_PAID,
			jdbcType=NUMERIC},
			TASK_ADDR=#{TASK_ADDR},
			TASK_LONGITUDE=#{TASK_LONGITUDE,
			jdbcType=NUMERIC},
			TASK_LATITUDE=#{TASK_LATITUDE,
			jdbcType=NUMERIC},
			TASK_ICON1=#{TASK_ICON1},
			TASK_ICON2=#{TASK_ICON2},
			TASK_ICON3=#{TASK_ICON3},
			TASK_ICON4=#{TASK_ICON4} 
		WHERE
			TASK_ID = #{TASK_ID}
    </update> 
    <select id="getTaskHeadByTaskId" parameterType="map" resultType="Map">
     	SELECT * FROM T_TASKS
     	WHERE TASK_ID = #{TASK_ID}
     	TASK_AUDIT_STATUS = '20'
    </select>
    <select id="getTaskLineByTaskId" parameterType="map" resultType="Map">
     	SELECT * FROM T_TASKS_LINE
     	WHERE TASK_ID = #{TASK_ID}
    </select>
    
    <select id="searchTaskList" parameterType="map" resultType="Map">
          SELECT A.*,B.USER_NAME,B.USER_ICON,
          SQRT(POWER(#{LONGITUDE, jdbcType=NUMERIC}-A.TASK_LONGITUDE,2)+POWER(#{LATITUDE, jdbcType=NUMERIC}-A.TASK_LATITUDE,2)) * 140000 DIST
          FROM T_TASKS A, T_USERS B
          WHERE A.TASK_AUDIT_STATUS = '20'
          <if test="USER_ID != null and USER_ID != '' ">  
          		AND A.USER_ID = #{USER_ID}  
          		AND B.USER_ID = #{USER_ID}
          		AND A.USER_ID = B.USER_ID
    	  </if> 
    	  <if test="SECTOR_ID != null and SECTOR_ID != '' ">  
          		AND A.SECTOR_ID = #{SECTOR_ID} 
    	  </if>
    	  <if test="SECTOR_TYPE != null and SECTOR_TYPE != '' ">  
          		AND A.SECTOR_TYPE = #{SECTOR_TYPE} 
    	  </if>
    	  <if test="TASK_TITLE != null and TASK_TITLE != '' ">  
          		AND A.TASK_TITLE LIKE CONCAT(CONCAT('%', #{TASK_TITLE, jdbcType=VARCHAR}),'%') 
    	  </if>
    </select>
</mapper>